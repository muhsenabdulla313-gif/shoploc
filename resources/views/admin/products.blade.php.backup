{{-- resources/views/admin/products/index.blade.php --}}

@extends('admin.layout')

@section('title', 'Admin - Products')
@section('page-title', 'Products Management')

@section('content')
<div class="space-y-6">
    <!-- Header with Add Button -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <h2 class="text-2xl font-bold text-gray-800">All Products</h2>
        <button type="button" onclick="openAddProductModal()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition-colors flex items-center">
            <i class="fas fa-plus mr-2"></i> Add New Product
        </button>
    </div>

    <!-- Search and Filter Bar -->
    <div class="bg-white rounded-xl p-4 shadow-md">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <input type="text" placeholder="Search products..."
                    class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="flex gap-2">
                <select
                    class="px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option>All Categories</option>
                    <option>Men</option>
                    <option>Women</option>
                    <option>Kids</option>
                </select>
                <select
                    class="px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option>All Status</option>
                    <option>Active</option>
                    <option>Inactive</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Products Table -->
    <div class="bg-white rounded-xl shadow-md overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
                </thead>

                <tbody class="bg-white divide-y divide-gray-200">
                @forelse($products as $product)
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <img class="h-10 w-10 rounded-md object-cover"
                                         src="{{ $product->image ? asset('storage/' . $product->image) : 'https://via.placeholder.com/40x40' }}"
                                         alt="{{ $product->name }}">
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">{{ $product->name }}</div>
                                    <div class="text-sm text-gray-500">{{ $product->category }}</div>
                                </div>
                            </div>
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${{ number_format($product->price, 2) }}
                            @if($product->original_price && $product->original_price > $product->price)
                                <span class="block text-sm text-red-500 line-through">
                                    ${{ number_format($product->original_price, 2) }}
                                </span>
                            @endif
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                @if($product->stock > 10) bg-green-100 text-green-800
                                @elseif($product->stock > 0) bg-yellow-100 text-yellow-800
                                @else bg-red-100 text-red-800 @endif">
                                {{ $product->stock }} in stock
                            </span>
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full
                                @if($product->status == 'active') bg-green-100 text-green-800
                                @else bg-red-100 text-red-800 @endif">
                                {{ ucfirst($product->status) }}
                            </span>
                        </td>

                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button type="button" onclick="viewProduct({{ $product->id }})"
                                    class="text-green-600 hover:text-green-900 mr-3">
                                <i class="fas fa-eye"></i>
                            </button>

                            <button type="button" onclick="editProduct({{ $product->id }})"
                                    class="text-blue-600 hover:text-blue-900 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>

                            <button type="button" onclick="deleteProduct({{ $product->id }})"
                                    class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                @empty
                    <tr>
                        <td colspan="5" class="px-6 py-4 text-center text-sm text-gray-500">
                            No products found.
                        </td>
                    </tr>
                @endforelse
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if(isset($products) && $products->hasPages())
        <div class="bg-white px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
            <div class="flex-1 flex justify-between sm:hidden">
                <a href="#" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Previous
                </a>
                <a href="#" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Next
                </a>
            </div>
            <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
                <div>
                    <p class="text-sm text-gray-700">
                        Showing <span class="font-medium">{{ $products->firstItem() }}</span>
                        to <span class="font-medium">{{ $products->lastItem() }}</span>
                        of <span class="font-medium">{{ $products->total() }}</span> results
                    </p>
                </div>
                <div>
                    {{ $products->links() }}
                </div>
            </div>
        </div>
        @endif
    </div>
</div>

<!-- Add Category Modal -->
<div id="categoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto mx-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Add New Category</h3>
            <button type="button" onclick="closeCategoryModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>

        <form id="categoryForm">
            @csrf
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Category Name</label>
                <input type="text" id="categoryName" name="name" required
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="Enter category name">
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeCategoryModal()"
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit"
                        class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                    Add Category
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add/Edit Product Modal -->
<div id="productModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto mx-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 id="modalTitle" class="text-xl font-semibold">Add New Product</h3>
            <button type="button" onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>

        <form id="productForm" enctype="multipart/form-data">
            @csrf
            <input type="hidden" id="productId" name="id">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                    <input type="text" id="productName" name="name" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                    <div class="flex gap-2">
                        <select id="productCategory" name="category" required
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Category</option>
                        </select>
                        <button type="button" onclick="openAddCategoryModal()"
                                class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md transition-colors flex items-center"
                                title="Add New Category">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Price</label>
                    <input type="number" id="productPrice" name="price" step="0.01" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Original Price</label>
                    <input type="number" id="productOriginalPrice" name="original_price" step="0.01"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Stock Quantity</label>
                    <input type="number" id="productStock" name="stock" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                    <select id="productStatus" name="status" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="productDescription" name="description" rows="3"
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Colors (comma separated)</label>
                    <input type="text" id="productColors" name="colors" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="red,blue,green">
                    <p class="text-xs text-gray-500 mt-1">Enter colors separated by commas (e.g., red,blue,green)</p>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Sizes (comma separated)</label>
                    <input type="text" id="productSizes" name="sizes" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                           placeholder="S,M,L,XL"
                           onchange="generateSizePriceFields()">
                    <p class="text-xs text-gray-500 mt-1">Enter sizes separated by commas (e.g., S,M,L,XL)</p>
                </div>

                <div class="md:col-span-2" id="sizePricesSection" style="display: none;">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Size Prices</label>
                    <div id="sizePricesContainer" class="space-y-2">
                        <!-- Size price fields will be generated here -->
                    </div>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Main Image</label>
                    <input type="file" id="mainImage" name="main_image" accept="image/*"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">This will be the primary product image</p>

                    <div id="mainImagePreview" class="mt-3 hidden">
                        <img id="mainPreviewImg" src="" alt="Main Image Preview"
                             class="h-32 w-32 object-cover rounded-md border">
                    </div>
                </div>

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Additional Images (Multiple)</label>
                    <input type="file" id="productImages" name="images[]" accept="image/*" multiple
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">Ctrl/Cmd hold cheyth select multiple images</p>

                    <div id="imagesPreview"
                         class="mt-3 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3 hidden">
                    </div>
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-3">
                <button type="button" onclick="closeModal()"
                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                    Cancel
                </button>
                <button type="submit"
                        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    Save Product
                </button>
            </div>
        </form>
    </div>
</div>
@endsection


{{-- IMPORTANT: put JS in scripts stack (layout must have @stack('scripts') before </body>) --}}
@push('scripts')
<script>
/** Helper: CSRF token (layout head must have meta csrf-token) */
function getCsrfToken() {
    const el = document.querySelector('meta[name="csrf-token"]');
    return el ? el.getAttribute('content') : '';
}

/** Modal open/close (Tailwind hidden + display flex) */
function openModal(id) {
    const modal = document.getElementById(id);
    if (!modal) return;
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
}
function closeModalById(id) {
    const modal = document.getElementById(id);
    if (!modal) return;
    modal.classList.add('hidden');
    modal.style.display = 'none';
}

/** Category modal */
function openAddCategoryModal() {
    const form = document.getElementById('categoryForm');
    if (form) form.reset();

    closeModalById('productModal');
    openModal('categoryModal');
}
function closeCategoryModal() {
    openModal('productModal'); // reopen product modal (optional)
    closeModalById('categoryModal');
}

/** Product modal */
function openAddProductModal() {
    const form = document.getElementById('productForm');
    if (form) form.reset();

    const title = document.getElementById('modalTitle');
    if (title) title.textContent = 'Add New Product';

    const productId = document.getElementById('productId');
    if (productId) productId.value = '';

    // Reset previews
    const mainPreviewWrap = document.getElementById('mainImagePreview');
    const mainPreviewImg  = document.getElementById('mainPreviewImg');
    if (mainPreviewWrap) mainPreviewWrap.classList.add('hidden');
    if (mainPreviewImg) mainPreviewImg.src = '';

    const imagesPreview = document.getElementById('imagesPreview');
    if (imagesPreview) {
        imagesPreview.classList.add('hidden');
        imagesPreview.innerHTML = '';
    }

    openModal('productModal');
}
function closeModal() {
    closeModalById('productModal');
}

/** Load categories from backend */
function loadCategories() {
    const categorySelect = document.getElementById('productCategory');
    if (!categorySelect) return;

    fetch('/admin/categories')
        .then(r => r.json())
        .then(data => {
            if (!data.success) return;

            categorySelect.innerHTML = '<option value="">Select Category</option>';
            data.data.forEach(category => {
                const opt = document.createElement('option');
                opt.value = category.name;
                opt.textContent = category.name;
                categorySelect.appendChild(opt);
            });
        })
        .catch(err => console.error('Error loading categories:', err));
}

/** Generate size price fields dynamically */
function generateSizePriceFields() {
    const sizesInput = document.getElementById('productSizes');
    const sizePricesSection = document.getElementById('sizePricesSection');
    const sizePricesContainer = document.getElementById('sizePricesContainer');
    
    if (!sizesInput || !sizePricesSection || !sizePricesContainer) return;
    
    const sizesValue = sizesInput.value.trim();
    
    if (sizesValue) {
        const sizes = sizesValue.split(',').map(size => size.trim()).filter(size => size);
        
        if (sizes.length > 0) {
            sizePricesSection.style.display = 'block';
                
            let html = '';
            sizes.forEach(size => {
                html += `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2 p-3 border rounded-md bg-gray-50">
                        <div class="flex items-center gap-2">
                            <label class="w-20 text-sm font-medium text-gray-700">${size} Price:</label>
                            <input 
                                type="number" 
                                data-size="${size}"
                                data-type="regular"
                                name="size_prices[${size}][price]"
                                step="0.01"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Regular price for ${size}">
                        </div>
                        <div class="flex items-center gap-2">
                            <label class="w-20 text-sm font-medium text-gray-700">${size} Orig:</label>
                            <input 
                                type="number" 
                                data-size="${size}"
                                data-type="original"
                                name="size_prices[${size}][original_price]"
                                step="0.01"
                                class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                placeholder="Original price for ${size}">
                        </div>
                    </div>
                `;
            });
                
            sizePricesContainer.innerHTML = html;
        } else {
            sizePricesSection.style.display = 'none';
            sizePricesContainer.innerHTML = '';
        }
    } else {
        sizePricesSection.style.display = 'none';
        sizePricesContainer.innerHTML = '';
    }
}

/** Actions */
function editProduct(id) {
    fetch(`/admin/products/${id}`)
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                alert(data.message || 'Error loading product');
                return;
            }

            const product = data.data;

            document.getElementById('modalTitle').textContent = 'Edit Product';
            document.getElementById('productId').value = product.id || '';
            document.getElementById('productName').value = product.name || '';
            document.getElementById('productCategory').value = product.category || '';
            document.getElementById('productPrice').value = product.price || '';
            document.getElementById('productOriginalPrice').value = product.original_price || '';
            document.getElementById('productStock').value = product.stock || '';
            document.getElementById('productStatus').value = product.status || 'active';
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productColors').value = Array.isArray(product.colors) ? product.colors.join(',') : (product.colors || '');
            document.getElementById('productSizes').value = Array.isArray(product.sizes) ? product.sizes.join(',') : (product.sizes || '');
            
            // Populate size prices if they exist
            if (product.size_prices && typeof product.size_prices === 'object') {
                // Trigger the generation of size price fields
                generateSizePriceFields();
                
                // Wait a bit for the fields to be generated, then populate them
                setTimeout(() => {
                    const sizePricesContainer = document.getElementById('sizePricesContainer');
                    if (sizePricesContainer) {
                        // Loop through the size prices and populate the fields
                        for (const size in product.size_prices) {
                            const sizePriceData = product.size_prices[size];
                            
                            // Handle both the old format (direct price) and new format (object with price/original_price)
                            if (typeof sizePriceData === 'object') {
                                // New format: {price: ..., original_price: ...}
                                const regularField = sizePricesContainer.querySelector(`input[data-size="${size}"][data-type="regular"]`);
                                const originalField = sizePricesContainer.querySelector(`input[data-size="${size}"][data-type="original"]`);
                                
                                if (regularField && sizePriceData.price !== undefined) {
                                    regularField.value = sizePriceData.price;
                                }
                                if (originalField && sizePriceData.original_price !== undefined) {
                                    originalField.value = sizePriceData.original_price;
                                }
                            } else {
                                // Old format: direct price value
                                const regularField = sizePricesContainer.querySelector(`input[data-size="${size}"][data-type="regular"]`);
                                if (regularField) {
                                    regularField.value = sizePriceData;
                                }
                            }
                        }
                    }
                }, 100);
            } else {
                // Just trigger the generation of size price fields based on sizes
                generateSizePriceFields();
            }

            // Previews reset
            const mainPreviewWrap = document.getElementById('mainImagePreview');
            const mainPreviewImg  = document.getElementById('mainPreviewImg');
            const imagesPreview   = document.getElementById('imagesPreview');

            if (mainPreviewWrap) mainPreviewWrap.classList.add('hidden');
            if (imagesPreview) {
                imagesPreview.classList.add('hidden');
                imagesPreview.innerHTML = '';
            }

            // main image
            if (product.image && mainPreviewImg && mainPreviewWrap) {
                mainPreviewImg.src = `/storage/${product.image}`;
                mainPreviewWrap.classList.remove('hidden');
            }

            // gallery images (optional)
            if (Array.isArray(product.gallery_images) && product.gallery_images.length > 0 && imagesPreview) {
                imagesPreview.classList.remove('hidden');
                product.gallery_images.forEach((path, idx) => {
                    const div = document.createElement('div');
                    div.className = 'relative';

                    const img = document.createElement('img');
                    img.src = `/storage/${path}`;
                    img.alt = `Preview ${idx+1}`;
                    img.className = 'h-24 w-full object-cover rounded-md border';

                    div.appendChild(img);
                    imagesPreview.appendChild(div);
                });
            }

            openModal('productModal');
        })
        .catch(err => {
            console.error(err);
            alert('Error loading product');
        });
}

function deleteProduct(id) {
    if (!confirm('Are you sure you want to delete this product?')) return;

    fetch(`/admin/products/${id}`, {
        method: 'DELETE',
        headers: {
            'X-CSRF-TOKEN': getCsrfToken()
        }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
        else alert('Error deleting: ' + (data.message || 'Unknown error'));
    })
    .catch(err => {
        console.error(err);
        alert('Network error while deleting');
    });
}

function viewProduct(id) {
    fetch(`/admin/products/${id}`)
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                alert(data.message || 'Error loading product');
                return;
            }

            const product = data.data;

            closeViewModal();

            const modalHtml = `
            <div id="viewProductModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
              <div class="bg-white rounded-xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto mx-auto">
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-xl font-semibold">Product Details</h3>
                  <button type="button" onclick="closeViewModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-2xl"></i>
                  </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Product Image</h4>
                    <div class="border rounded-md p-2">
                      <img src="${product.image ? '/storage/' + product.image : 'https://via.placeholder.com/300x300'}"
                           alt="${product.name || ''}"
                           class="w-full h-64 object-contain rounded">
                    </div>

                    ${
                      product.gallery_images && product.gallery_images.length > 0
                      ? `<div class="mt-4">
                           <h5 class="text-md font-medium text-gray-700 mb-2">Additional Images</h5>
                           <div class="flex flex-wrap gap-2">
                             ${product.gallery_images.map(img => `
                               <img src="/storage/${img}" alt="Additional" class="w-20 h-20 object-cover rounded border">
                             `).join('')}
                           </div>
                         </div>`
                      : ''
                    }
                  </div>

                  <div>
                    <div class="mb-3">
                      <div class="text-sm text-gray-500">Name</div>
                      <div class="text-gray-900 font-semibold">${product.name || ''}</div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-3">
                      <div>
                        <div class="text-sm text-gray-500">Category</div>
                        <div class="text-gray-900">${product.category || 'N/A'}</div>
                      </div>
                      <div>
                        <div class="text-sm text-gray-500">Subcategory</div>
                        <div class="text-gray-900">${product.subcategory || 'N/A'}</div>
                      </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-3">
                      <div>
                        <div class="text-sm text-gray-500">Price</div>
                        <div class="text-gray-900">$${product.price ? parseFloat(product.price).toFixed(2) : '0.00'}</div>
                      </div>
                      <div>
                        <div class="text-sm text-gray-500">Original Price</div>
                        <div class="text-gray-900">${product.original_price ? ('$' + parseFloat(product.original_price).toFixed(2)) : 'N/A'}</div>
                      </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-3">
                      <div>
                        <div class="text-sm text-gray-500">Stock</div>
                        <div class="text-gray-900">${product.stock ?? 'N/A'}</div>
                      </div>
                      <div>
                        <div class="text-sm text-gray-500">Status</div>
                        <div class="text-gray-900">${product.status || 'N/A'}</div>
                      </div>
                    </div>

                    <div class="mb-3">
                      <div class="text-sm text-gray-500">Description</div>
                      <div class="text-gray-900">${product.description || 'N/A'}</div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-3">
                      <div>
                        <div class="text-sm text-gray-500">Colors</div>
                        <div class="text-gray-900">${Array.isArray(product.colors) ? product.colors.join(', ') : (product.colors || 'N/A')}</div>
                      </div>
                      <div>
                        <div class="text-sm text-gray-500">Sizes</div>
                        <div class="text-gray-900">${Array.isArray(product.sizes) ? product.sizes.join(', ') : (product.sizes || 'N/A')}</div>
                      </div>
                    </div>

                    ${
                      product.size_prices && typeof product.size_prices === 'object' && Object.keys(product.size_prices).length > 0
                      ? `<div class="mb-3">
                           <div class="text-sm text-gray-500">Size Prices</div>
                           <div class="text-gray-900">
                             ${Object.entries(product.size_prices).map(([size, price]) => `${size}: $${parseFloat(price).toFixed(2)}`).join('<br>')}
                           </div>
                         </div>`
                      : ''
                    }

                    <div class="mt-5 flex justify-end">
                      <button type="button" onclick="closeViewModal()"
                              class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                        Close
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>`;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
        })
        .catch(err => {
            console.error(err);
            alert('Network error while loading product');
        });
}

function closeViewModal() {
    const modal = document.getElementById('viewProductModal');
    if (modal) modal.remove();
}

/** DOM Ready: attach listeners safely (null-check) */
document.addEventListener('DOMContentLoaded', () => {
    // Make sure modals display none by default
    closeModalById('productModal');
    closeModalById('categoryModal');

    loadCategories();

    const mainImageEl = document.getElementById('mainImage');
    if (mainImageEl) {
        mainImageEl.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const wrap = document.getElementById('mainImagePreview');
            const img  = document.getElementById('mainPreviewImg');
            if (!wrap || !img) return;

            if (file) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    img.src = ev.target.result;
                    wrap.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                wrap.classList.add('hidden');
                img.src = '';
            }
        });
    }

    const productImagesEl = document.getElementById('productImages');
    if (productImagesEl) {
        productImagesEl.addEventListener('change', function(e) {
            const files = Array.from(e.target.files || []);
            const preview = document.getElementById('imagesPreview');
            if (!preview) return;

            preview.innerHTML = '';

            if (files.length === 0) {
                preview.classList.add('hidden');
                return;
            }

            preview.classList.remove('hidden');

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    const div = document.createElement('div');
                    div.className = 'relative';

                    const img = document.createElement('img');
                    img.src = ev.target.result;
                    img.alt = `Preview ${index + 1}`;
                    img.className = 'h-24 w-full object-cover rounded-md border';

                    div.appendChild(img);
                    preview.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        });
    }

    const categoryForm = document.getElementById('categoryForm');
    if (categoryForm) {
        categoryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const name = (document.getElementById('categoryName')?.value || '').trim();
            if (!name) return;

            const formData = new FormData(this);

            fetch('/admin/categories', {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRF-TOKEN': getCsrfToken() }
            })
            .then(r => r.json())
            .then(data => {
                if (!data.success) {
                    alert(data.message || 'Error adding category');
                    return;
                }

                // reload categories and select new
                loadCategories();
                setTimeout(() => {
                    const sel = document.getElementById('productCategory');
                    if (sel) sel.value = data.data.name;
                }, 200);

                alert('Category added successfully!');
                closeModalById('categoryModal');
                openModal('productModal');
            })
            .catch(err => {
                console.error(err);
                alert('Network error while adding category');
            });
        });
    }

    const productForm = document.getElementById('productForm');
    if (productForm) {
        productForm.addEventListener('submit', function(e) {
            e.preventDefault();

            // Process colors and sizes from comma-separated strings to arrays
            const colorsInput = document.getElementById('productColors');
            const sizesInput = document.getElementById('productSizes');
            
            const formData = new FormData(this);
            
            // Convert colors to array if provided
            if (colorsInput && colorsInput.value.trim()) {
                const colorsArray = colorsInput.value.split(',').map(color => color.trim()).filter(color => color);
                // Remove the original string value
                formData.delete('colors');
                // Add each color as a separate array element
                colorsArray.forEach((color, index) => {
                    formData.append('colors[]', color);
                });
            } else {
                formData.delete('colors');
            }
            
            // Convert sizes to array if provided and handle size prices
            if (sizesInput && sizesInput.value.trim()) {
                const sizesArray = sizesInput.value.split(',').map(size => size.trim()).filter(size => size);
                // Remove the original string value
                formData.delete('sizes');
                // Add each size as a separate array element
                sizesArray.forEach((size, index) => {
                    formData.append('sizes[]', size);
                });
                
                // Also collect size-specific prices if they exist
                const sizePricesContainer = document.getElementById('sizePricesContainer');
                if (sizePricesContainer) {
                    const sizeGroups = sizePricesContainer.querySelectorAll('.grid.grid-cols-1');
                    sizeGroups.forEach(group => {
                        const regularInput = group.querySelector('input[data-type="regular"]');
                        const originalInput = group.querySelector('input[data-type="original"]');
                        
                        if (regularInput) {
                            const size = regularInput.getAttribute('data-size');
                            const regularPrice = regularInput.value;
                            if (size && regularPrice) {
                                // Add regular price
                                formData.append(`size_prices[${size}][price]`, regularPrice);
                            }
                        }
                        
                        if (originalInput) {
                            const size = originalInput.getAttribute('data-size');
                            const originalPrice = originalInput.value;
                            if (size && originalPrice) {
                                // Add original price
                                formData.append(`size_prices[${size}][original_price]`, originalPrice);
                            }
                        }
                    });
                }
            } else {
                formData.delete('sizes');
                // Also remove any size_prices if no sizes are provided
                formData.delete('size_prices');
            }

            const id = document.getElementById('productId')?.value;

            const url = id ? `/admin/products/${id}` : '/admin/products';
            const method = id ? 'POST' : 'POST'; // use POST with _method for Laravel

            if (id) formData.append('_method', 'PUT');

            fetch(url, {
                method: method,
                body: formData,
                headers: { 'X-CSRF-TOKEN': getCsrfToken() }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    alert('Product saved successfully!');
                    closeModal();
                    location.reload();
                    return;
                }

                if (data.errors) {
                    let msg = 'Validation errors:\n';
                    for (const k in data.errors) msg += `- ${k}: ${data.errors[k].join(', ')}\n`;
                    alert(msg);
                } else {
                    // Show detailed error message
                    let errorMsg = 'Error saving product: ' + (data.message || 'Unknown error');
                    if (data.error_details) {
                        errorMsg += '\n\nDetails:\n';
                        errorMsg += `Message: ${data.error_details.message}\n`;
                        errorMsg += `File: ${data.error_details.file}\n`;
                        errorMsg += `Line: ${data.error_details.line}`;
                    }
                    alert(errorMsg);
                }
            })
            .catch(err => {
                console.error(err);
                alert('Network error while saving product');
            });
        });
    }
});
</script>
@endpush
